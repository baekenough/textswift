name: Release Notes Generator

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.1.0)"
        required: true
        type: string
      previous_tag:
        description: "Previous tag to compare (optional)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine version from workflow_run
        if: github.event_name == 'workflow_run'
        id: from_run
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          if [[ ! "$TAG" =~ ^v[0-9] ]]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
            TAG=$(git tag --points-at "$SHA" | grep "^v" | head -1)
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT

      - name: Determine version from dispatch
        if: github.event_name == 'workflow_dispatch'
        id: from_dispatch
        run: |
          echo "tag=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "tag=${{ steps.from_run.outputs.tag }}" >> $GITHUB_OUTPUT
            echo "version=${{ steps.from_run.outputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ steps.from_dispatch.outputs.tag }}" >> $GITHUB_OUTPUT
            echo "version=${{ steps.from_dispatch.outputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout release tag
        run: git checkout "${{ steps.version.outputs.tag }}"

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2

      - name: Install Anthropic SDK
        run: bun add @anthropic-ai/sdk

      - name: Find previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.version.outputs.tag }}"
          if [ -n "${{ inputs.previous_tag }}" ]; then
            echo "tag=${{ inputs.previous_tag }}" >> $GITHUB_OUTPUT
          else
            PREV=$(git tag --sort=-version:refname | grep -v "^${CURRENT_TAG}$" | head -1)
            echo "tag=$PREV" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          PREVIOUS_TAG: ${{ steps.prev_tag.outputs.tag }}
        run: |
          bun run .github/scripts/generate-release-notes.ts "${{ steps.version.outputs.version }}" > release_notes.md
          cat release_notes.md

      - name: Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          draft: false
          prerelease: >-
            ${{ contains(steps.version.outputs.tag, '-alpha') ||
                contains(steps.version.outputs.tag, '-beta') ||
                contains(steps.version.outputs.tag, '-rc') }}

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ steps.version.outputs.tag }}
          path: release_notes.md

      - name: Comment summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "## Release Notes Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat release_notes.md >> $GITHUB_STEP_SUMMARY
